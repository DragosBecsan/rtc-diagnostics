{"version":3,"file":"BitrateTest.js","sourceRoot":"","sources":["../../lib/BitrateTest.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;AAAA,iCAAsC;AACtC,yCAA0G;AAC1G,4DAA2D;AAyD3D;;;;;;GAMG;AACH;IAAiC,+BAAY;IA4E3C;;;;;OAKG;IACH,qBAAY,OAA4B;QAAxC,YACE,iBAAO,SAmBR;QA3FD;;WAEG;QACK,aAAO,GAAsB,EAAE,CAAC;QAExC;;WAEG;QACK,uBAAiB,GAAW,CAAC,CAAC;QAEtC;;WAEG;QACK,2BAAqB,GAAW,CAAC,CAAC;QAE1C;;WAEG;QACK,oBAAc,GAAkB,EAAE,CAAC;QAY3C;;WAEG;QACK,uBAAiB,GAAqB,EAAE,CAAC;QAYjD;;WAEG;QACK,iBAAW,GAAoB,EAAE,KAAK,EAAE,CAAC,EAAE,CAAC;QAEpD;;WAEG;QACK,yBAAmB,GAAW,CAAC,CAAC;QAExC;;WAEG;QACK,aAAO,GAAa,EAAE,CAAC;QAE/B;;WAEG;QACK,eAAS,GAA2B,EAAE,CAAC;QAW7C,OAAO,GAAG,OAAO,IAAI,EAAE,CAAC;QACxB,KAAI,CAAC,iBAAiB,CAAC,UAAU,GAAG,OAAO,CAAC,UAAU,CAAC;QAEvD,KAAI,CAAC,WAAW,GAAG,IAAI,iBAAiB,CAAC,KAAI,CAAC,iBAAiB,CAAC,CAAC;QACjE,KAAI,CAAC,SAAS,GAAG,IAAI,iBAAiB,CAAC,KAAI,CAAC,iBAAiB,CAAC,CAAC;QAE/D,KAAI,CAAC,WAAW,CAAC,cAAc,GAAG,UAAC,KAAgC,IAAK,OAAA,KAAI,CAAC,eAAe,CAAC,KAAI,CAAC,SAAS,EAAE,KAAK,CAAC,EAA3C,CAA2C,CAAC;QACpH,KAAI,CAAC,SAAS,CAAC,cAAc,GAAG,UAAC,KAAgC,IAAK,OAAA,KAAI,CAAC,eAAe,CAAC,KAAI,CAAC,WAAW,EAAE,KAAK,CAAC,EAA7C,CAA6C,CAAC;QAEpH,KAAI,CAAC,sBAAsB,CAAC,KAAI,CAAC,SAAS,CAAC,CAAC;QAE5C,oDAAoD;QACpD,+BAA+B;QAC/B,UAAU,CAAC;YACT,KAAI,CAAC,iBAAiB,EAAE,CAAC;YACzB,KAAI,CAAC,UAAU,EAAE,CAAC;QACpB,CAAC,CAAC,CAAC;;IACL,CAAC;IAED;;OAEG;IACH,0BAAI,GAAJ;QACE,aAAa,CAAC,IAAI,CAAC,mBAAoB,CAAC,CAAC;QACzC,aAAa,CAAC,IAAI,CAAC,uBAAwB,CAAC,CAAC;QAE7C,IAAI,CAAC,SAAS,CAAC,KAAK,EAAE,CAAC;QACvB,IAAI,CAAC,WAAW,CAAC,KAAK,EAAE,CAAC;QAEzB,IAAI,CAAC,WAAW,CAAC,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QAClC,IAAI,CAAC,WAAW,CAAC,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,GAAG,GAAG,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC;QAE1E,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,GAAG,EAAE,IAAI,CAAC,UAAU,EAAE,CAAC,CAAC;IACvD,CAAC;IAED;;OAEG;IACK,mCAAa,GAArB;QACE,cAAc;QACd,IAAI,CAAC,IAAI,CAAC,qBAAqB,IAAI,CAAC,IAAI,CAAC,iBAAiB,EAAE;YAC1D,IAAI,CAAC,qBAAqB,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;YACxC,IAAI,CAAC,iBAAiB,GAAG,IAAI,CAAC,mBAAmB,CAAC;YAClD,OAAO;SACR;QAED,4BAA4B;QAC5B,IAAM,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QACvB,IAAM,OAAO,GAAG,CAAC,GAAG,CAAC,IAAI,CAAC,mBAAmB,GAAG,IAAI,CAAC,iBAAiB,CAAC,GAAG,CAAC,GAAG,GAAG,IAAI,CAAC,qBAAqB,CAAC,CAAC;QAE7G,IAAI,CAAC,qBAAqB,GAAG,GAAG,CAAC;QACjC,IAAI,CAAC,iBAAiB,GAAG,IAAI,CAAC,mBAAmB,CAAC;QAClD,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QAC3B,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;IACjD,CAAC;IAED;;OAEG;IACK,gCAAU,GAAlB;QACE,IAAI,cAAc,GAAG,IAAI,CAAC,OAAO;aAC9B,MAAM,CAAC,UAAC,KAAa,EAAE,KAAa,IAAK,OAAA,KAAK,IAAI,KAAK,EAAd,CAAc,EAAE,CAAC,CAAC,GAAG,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC;QACrF,cAAc,GAAG,KAAK,CAAC,cAAc,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,cAAc,CAAC;QAE5D,OAAO;YACL,cAAc,gBAAA;YACd,OAAO,EAAE,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,IAAI,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,IAAI,cAAc,IAAI,iCAAqB;YACjG,MAAM,EAAE,IAAI,CAAC,OAAO;YACpB,aAAa,EAAE,IAAI,CAAC,cAAc;YAClC,QAAQ,EAAE,WAAW,CAAC,QAAQ;YAC9B,UAAU,EAAE,IAAI,CAAC,WAAW;YAC5B,MAAM,EAAE,IAAI,CAAC,OAAO;YACpB,QAAQ,EAAE,IAAI,CAAC,SAAS;SACzB,CAAC;IACJ,CAAC;IAED;;;;OAIG;IACK,uCAAiB,GAAzB,UAA0B,IAA0B,EAAE,gBAAwB;QAC5E,IAAI,gBAAgB,GAAG,WAAW,CAAC,iBAAiB,CAAC,IAAI,CAAC,EAAE;YAC1D,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAC1B,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC;SAC7C;IACH,CAAC;IAED;;;;;OAKG;IACK,8BAAQ,GAAhB,UAAiB,OAAe,EAAE,KAAgB;QAChD,IAAM,eAAe,GAAG,IAAI,iCAAe,CAAC,KAAK,EAAE,OAAO,CAAC,CAAC;QAC5D,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;QACnC,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,KAAK,EAAE,eAAe,CAAC,CAAC;QACrD,IAAI,CAAC,IAAI,EAAE,CAAC;IACd,CAAC;IAED;;;OAGG;IACK,qCAAe,GAAvB,UAAwB,QAA2B,EAAE,KAAgC;QAArF,iBAQC;QAPC,IAAI,KAAK,CAAC,SAAS,EAAE;YACnB,IAAM,SAAS,GAAG,KAAK,CAAC,SAAS,CAAC,SAAS,CAAC;YAC5C,IAAI,SAAS,CAAC,OAAO,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC,EAAE;gBACrC,QAAQ,CAAC,eAAe,CAAC,KAAK,CAAC,SAAS,CAAC;qBACtC,KAAK,CAAC,UAAC,KAAe,IAAK,OAAA,KAAI,CAAC,QAAQ,CAAC,yBAAyB,EAAE,KAAK,CAAC,EAA/C,CAA+C,CAAC,CAAC;aAChF;SACF;IACH,CAAC;IAED;;;OAGG;IACK,wCAAkB,GAA1B,UAA2B,KAAmB;QAC5C,IAAI,CAAC,mBAAmB,IAAI,KAAK,CAAC,IAAI,CAAC,MAAM,CAAC;QAE9C,IAAI,CAAC,IAAI,CAAC,cAAc,CAAC,WAAW,EAAE;YACpC,IAAI,CAAC,cAAc,CAAC,WAAW,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;YAC7C,IAAI,CAAC,iBAAiB,CACpB,WAAW,CAAC,QAAQ,CAAC,uBAAuB,EAC5C,IAAI,CAAC,cAAc,CAAC,WAAW,GAAG,IAAI,CAAC,WAAW,CAAC,KAAK,CACzD,CAAC;SACH;IACH,CAAC;IAED;;;OAGG;IACK,8CAAwB,GAAhC,UAAiC,MAAiC;QAAlE,iBAMC;QALC,OAAO,OAAO,CAAC,GAAG,CAAC;YACjB,IAAI,CAAC,WAAW,CAAC,mBAAmB,CAAC,MAAM,CAAC;YAC5C,IAAI,CAAC,SAAS,CAAC,oBAAoB,CAAC,MAAM,CAAC;SAC5C,CAAC,CAAC,KAAK,CAAC,UAAC,KAAe;YACvB,OAAA,KAAI,CAAC,QAAQ,CAAC,6DAA6D,EAAE,KAAK,CAAC;QAAnF,CAAmF,CAAC,CAAC;IACzF,CAAC;IAED;;;OAGG;IACK,2CAAqB,GAA7B,UAA8B,KAAgC;QAA9D,iBAMC;QALC,OAAO,OAAO,CAAC,GAAG,CAAC;YACjB,IAAI,CAAC,SAAS,CAAC,mBAAmB,CAAC,KAAK,CAAC;YACzC,IAAI,CAAC,WAAW,CAAC,oBAAoB,CAAC,KAAK,CAAC;SAC7C,CAAC,CAAC,KAAK,CAAC,UAAC,KAAe;YACvB,OAAA,KAAI,CAAC,QAAQ,CAAC,4DAA4D,EAAE,KAAK,CAAC;QAAlF,CAAkF,CAAC,CAAC;IACxF,CAAC;IAED;;OAEG;IACK,+BAAS,GAAjB;QACE,IAAI,CAAC,IAAI,CAAC,eAAe,IAAI,IAAI,CAAC,eAAe,CAAC,UAAU,KAAK,MAAM,EAAE;YACvE,OAAO;SACR;QACD,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,8BAAkB,EAAE,EAAE,CAAC,EAAE;YAC3C,IAAI,IAAI,CAAC,eAAe,CAAC,cAAc,IAAI,+BAAmB,EAAE;gBAC9D,MAAM;aACP;YACD,IAAI,CAAC,eAAe,CAAC,IAAI,CAAC,uBAAW,CAAC,CAAC;SACxC;IACH,CAAC;IAED;;OAEG;IACK,uCAAiB,GAAzB;QAAA,iBAgBC;QAfC,IAAI;YACF,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC,SAAS,CAAC,iBAAiB,CAAC,QAAQ,CAAC,CAAC;SACnE;QAAC,OAAO,CAAC,EAAE;YACV,IAAI,CAAC,QAAQ,CAAC,6BAA6B,EAAE,CAAC,CAAC,CAAC;YAChD,OAAO;SACR;QAED,IAAI,CAAC,eAAe,CAAC,MAAM,GAAG;YAC5B,KAAI,CAAC,mBAAmB,GAAG,WAAW,CAAC,cAAM,OAAA,KAAI,CAAC,SAAS,EAAE,EAAhB,CAAgB,EAAE,CAAC,CAAC,CAAC;YAClE,KAAI,CAAC,uBAAuB,GAAG,WAAW,CAAC,cAAM,OAAA,KAAI,CAAC,aAAa,EAAE,EAApB,CAAoB,EAAE,IAAI,CAAC,CAAC;QAC/E,CAAC,CAAC;QAEF,IAAI,CAAC,WAAW,CAAC,aAAa,GAAG,UAAC,gBAAqC;YACrE,gBAAgB,CAAC,OAAO,CAAC,SAAS,GAAG,UAAC,KAAmB,IAAK,OAAA,KAAI,CAAC,kBAAkB,CAAC,KAAK,CAAC,EAA9B,CAA8B,CAAC;QAC/F,CAAC,CAAC;IACJ,CAAC;IAED;;;OAGG;IACK,4CAAsB,GAA9B,UAA+B,EAAqB;QAApD,iBAgCC;QA/BC,uBAAuB;QACvB,EAAE,CAAC,uBAAuB,GAAG;YAC3B,KAAI,CAAC,cAAc,CAAC,cAAc,GAAG,KAAI,CAAC,cAAc,CAAC,cAAc,IAAI,EAAE,KAAK,EAAE,CAAC,EAAE,CAAC;YAExF,IAAI,EAAE,CAAC,eAAe,KAAK,YAAY,EAAE;gBACvC,KAAI,CAAC,cAAc,CAAC,cAAc,CAAC,KAAK,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;aACvD;iBAAM,IAAI,EAAE,CAAC,eAAe,KAAK,WAAW,EAAE;gBAC7C,KAAI,CAAC,cAAc,CAAC,cAAc,CAAC,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;gBAE9C,IAAA,wCAAmD,EAAjD,gBAAK,EAAE,YAA0C,CAAC;gBAC1D,IAAM,QAAQ,GAAG,GAAG,GAAG,KAAK,CAAC;gBAC7B,KAAI,CAAC,cAAc,CAAC,cAAc,CAAC,QAAQ,GAAG,QAAQ,CAAC;gBACvD,KAAI,CAAC,iBAAiB,CAAC,WAAW,CAAC,QAAQ,CAAC,qBAAqB,EAAE,QAAQ,CAAC,CAAC;aAC9E;QACH,CAAC,CAAC;QAEF,uBAAuB;QACvB,EAAE,CAAC,0BAA0B,GAAG;YAC9B,KAAI,CAAC,cAAc,CAAC,GAAG,GAAG,KAAI,CAAC,cAAc,CAAC,GAAG,IAAI,EAAE,KAAK,EAAE,CAAC,EAAE,CAAC;YAElE,IAAI,EAAE,CAAC,kBAAkB,KAAK,UAAU,EAAE;gBACxC,KAAI,CAAC,cAAc,CAAC,GAAG,CAAC,KAAK,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;aAC5C;iBAAM,IAAI,EAAE,CAAC,kBAAkB,KAAK,WAAW,EAAE;gBAChD,KAAI,CAAC,cAAc,CAAC,GAAG,CAAC,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;gBAEnC,IAAA,6BAAwC,EAAtC,gBAAK,EAAE,YAA+B,CAAC;gBAC/C,IAAM,QAAQ,GAAG,GAAG,GAAG,KAAK,CAAC;gBAC7B,KAAI,CAAC,cAAc,CAAC,GAAG,CAAC,QAAQ,GAAG,QAAQ,CAAC;gBAC5C,KAAI,CAAC,iBAAiB,CAAC,WAAW,CAAC,QAAQ,CAAC,sBAAsB,EAAE,QAAQ,CAAC,CAAC;aAC/E;QACH,CAAC,CAAC;IACJ,CAAC;IAED;;OAEG;IACK,gCAAU,GAAlB;QAAA,iBAcC;QAbC,IAAI,CAAC,WAAW,CAAC,KAAK,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QAEpC,IAAI,CAAC,IAAI,CAAC,iBAAiB,CAAC,UAAU,EAAE;YACtC,OAAO,IAAI,CAAC,QAAQ,CAAC,qBAAqB,EAAE,SAAS,CAAC,CAAC;SACxD;QAED,IAAI,CAAC,SAAS,CAAC,WAAW,EAAE;aACzB,IAAI,CAAC,UAAC,KAAgC,IAAK,OAAA,KAAI,CAAC,qBAAqB,CAAC,KAAK,CAAC,EAAjC,CAAiC,CAAC;aAC7E,IAAI,CAAC;YACJ,OAAO,KAAI,CAAC,WAAW,CAAC,YAAY,EAAE;iBACnC,IAAI,CAAC,UAAC,MAAiC,IAAK,OAAA,KAAI,CAAC,wBAAwB,CAAC,MAAM,CAAC,EAArC,CAAqC,CAAC;iBAClF,KAAK,CAAC,UAAC,KAAY,IAAK,OAAA,KAAI,CAAC,QAAQ,CAAC,yBAAyB,EAAE,KAAK,CAAC,EAA/C,CAA+C,CAAC,CAAC;QAC9E,CAAC,CAAC,CAAC,KAAK,CAAC,UAAC,KAAY,IAAK,OAAA,KAAI,CAAC,QAAQ,CAAC,wBAAwB,EAAE,KAAK,CAAC,EAA9C,CAA8C,CAAC,CAAC;IAC/E,CAAC;IA1UD;;OAEG;IACa,oBAAQ,GAAW,cAAc,CAAC;IAwUpD,kBAAC;CAAA,AA5UD,CAAiC,qBAAY,GA4U5C;AA5UY,kCAAW;AA8UxB,WAAiB,WAAW;;IAC1B;;OAEG;IACH,IAAY,MAKX;IALD,WAAY,MAAM;QAChB,6BAAmB,CAAA;QACnB,qBAAW,CAAA;QACX,yBAAe,CAAA;QACf,6BAAmB,CAAA;IACrB,CAAC,EALW,MAAM,GAAN,kBAAM,KAAN,kBAAM,QAKjB;IAED;;OAEG;IACH,IAAY,QAgBX;IAhBD,WAAY,QAAQ;QAClB;;;WAGG;QACH,kEAAsD,CAAA;QAEtD;;WAEG;QACH,gEAAoD,CAAA;QAEpD;;WAEG;QACH,8DAAkD,CAAA;IACpD,CAAC,EAhBW,QAAQ,GAAR,oBAAQ,KAAR,oBAAQ,QAgBnB;IAED;;;OAGG;IACU,6BAAiB;QAC5B,GAAC,QAAQ,CAAC,uBAAuB,IAAG,IAAI;QACxC,GAAC,QAAQ,CAAC,sBAAsB,IAAG,GAAG;QACtC,GAAC,QAAQ,CAAC,qBAAqB,IAAG,IAAI;WACvC,CAAC;AAyFJ,CAAC,EAjIgB,WAAW,GAAX,mBAAW,KAAX,mBAAW,QAiI3B;AA/cY,kCAAW;AAidxB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;GAmCG;AACH,SAAgB,WAAW,CAAC,OAA4B;IACtD,OAAO,IAAI,WAAW,CAAC,OAAO,CAAC,CAAC;AAClC,CAAC;AAFD,kCAEC","sourcesContent":["import { EventEmitter } from 'events';\nimport { BYTES_KEEP_BUFFERED, MAX_NUMBER_PACKETS, MIN_BITRATE_THRESHOLD, TEST_PACKET } from './constants';\nimport { DiagnosticError } from './errors/DiagnosticError';\nimport { NetworkTiming, TimeMeasurement } from './timing';\n\nexport declare interface BitrateTest {\n  /**\n   * Raised every second with a `bitrate` parameter in kbps which represents the connection's bitrate since the last time this event was raised.\n   * The bitrate value is limited by either your downlink or uplink, whichever is lower.\n   * For example, if your downlink and uplink is 50mbps and 10mbps respectively, bitrate value will not exceed 10mbps.\n   * @param event [[BitrateTest.Events.Bitrate]].\n   * @param listener A callback with a `bitrate`(kbps) parameter since the last time this event was raised.\n   * @returns This [[BitrateTest]] instance.\n   * @event\n   */\n  on(\n    event: BitrateTest.Events.Bitrate,\n    listener: (bitrate: number) => any,\n  ): this;\n\n  /**\n   * Raised when the test encounters an error.\n   * When this happens, the test will immediately stop and emit [[BitrateTest.Events.End]].\n   * @param event [[BitrateTest.Events.Error]].\n   * @param listener A callback with a [[DiagnosticError]] parameter.\n   * @returns This [[BitrateTest]] instance.\n   * @event\n   */\n  on(\n    event: BitrateTest.Events.Error,\n    listener: (error: DiagnosticError) => any,\n  ): this;\n\n  /**\n   * Raised upon completion of the test.\n   * @param event [[BitrateTest.Events.End]].\n   * @param listener A callback with a [[BitrateTest.Report]] parameter.\n   * @returns This [[BitrateTest]] instance.\n   * @event\n   */\n  on(\n    event: BitrateTest.Events.End,\n    listener: (report: BitrateTest.Report) => any,\n  ): this;\n\n  /**\n   * Raised when the test encounters a warning such as HighFirstPacketDuration.\n   * See [[BitrateTest.Warnings]] for more information.\n   * @param event [[BitrateTest.Events.Warning]].\n   * @param listener A callback with a [[BitrateTest.Warnings]] parameter.\n   * @returns This [[BitrateTest]] instance.\n   * @event\n   */\n  on(\n    event: BitrateTest.Events.Warning,\n    listener: (warning: BitrateTest.Warnings) => any,\n  ): this;\n}\n\n/**\n * BitrateTest uses two [RTCPeerConnections](https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection)\n * connected via a [Twilio Network Traversal Service](https://www.twilio.com/docs/stun-turn).\n * Using [RTCDataChannel](https://developer.mozilla.org/en-US/docs/Web/API/RTCDataChannel), one RTCPeerConnection will saturate the data channel buffer and will\n * constantly send data packets to the other RTCPeerConnection. The receiving peer will measure the bitrate base on the amount of packets received every second.\n * See [[BitrateTest.Options.iceServers]] for information how to use Twilio NTS.\n */\nexport class BitrateTest extends EventEmitter {\n  /**\n   * Name of this test\n   */\n  static readonly testName: string = 'bitrate-test';\n\n  /**\n   * Interval id for checking bitrate\n   */\n  private _checkBitrateIntervalId: NodeJS.Timer | undefined;\n\n  /**\n   * Errors detected during the test\n   */\n  private _errors: DiagnosticError[] = [];\n\n  /**\n   * Number of bytes received the last time it was checked\n   */\n  private _lastBytesChecked: number = 0;\n\n  /**\n   * Last timestamp when the bytes received was checked\n   */\n  private _lastCheckedTimestamp: number = 0;\n\n  /**\n   * Network related timing for this test\n   */\n  private _networkTiming: NetworkTiming = {};\n\n  /**\n   * The RTCPeerConnection that will receive data\n   */\n  private _pcReceiver: RTCPeerConnection;\n\n  /**\n   * The RTCPeerConnection that will send data\n   */\n  private _pcSender: RTCPeerConnection;\n\n  /**\n   * RTC configuration that will be used when initializing a RTCPeerConnection\n   */\n  private _rtcConfiguration: RTCConfiguration = {};\n\n  /**\n   * RTCDataChannel to use for sending data\n   */\n  private _rtcDataChannel: RTCDataChannel | undefined;\n\n  /**\n   * Interval id for sending data\n   */\n  private _sendDataIntervalId: NodeJS.Timer | undefined;\n\n  /**\n   * Timing measurements for this test\n   */\n  private _testTiming: TimeMeasurement = { start: 0 };\n\n  /**\n   * Total number of bytes received by the receiver RTCPeerConnection\n   */\n  private _totalBytesReceived: number = 0;\n\n  /**\n   * Bitrate (kbps) values collected during the test\n   */\n  private _values: number[] = [];\n\n  /**\n   * Warnings detected during the test\n   */\n  private _warnings: BitrateTest.Warnings[] = [];\n\n  /**\n   * Construct a [[BitrateTest]] instance. The test will start immediately.\n   * Test should be allowed to run for a minimum of 8 seconds. To stop the test, call [[BitrateTest.stop]].\n   * @constructor\n   * @param options\n   */\n  constructor(options: BitrateTest.Options) {\n    super();\n\n    options = options || {};\n    this._rtcConfiguration.iceServers = options.iceServers;\n\n    this._pcReceiver = new RTCPeerConnection(this._rtcConfiguration);\n    this._pcSender = new RTCPeerConnection(this._rtcConfiguration);\n\n    this._pcReceiver.onicecandidate = (event: RTCPeerConnectionIceEvent) => this._onIceCandidate(this._pcSender, event);\n    this._pcSender.onicecandidate = (event: RTCPeerConnectionIceEvent) => this._onIceCandidate(this._pcReceiver, event);\n\n    this._setupNetworkListeners(this._pcSender);\n\n    // Return before starting the test to allow consumer\n    // to listen and capture errors\n    setTimeout(() => {\n      this._setupDataChannel();\n      this._startTest();\n    });\n  }\n\n  /**\n   * Stops the current test.\n   */\n  stop(): void {\n    clearInterval(this._sendDataIntervalId!);\n    clearInterval(this._checkBitrateIntervalId!);\n\n    this._pcSender.close();\n    this._pcReceiver.close();\n\n    this._testTiming.end = Date.now();\n    this._testTiming.duration = this._testTiming.end - this._testTiming.start;\n\n    this.emit(BitrateTest.Events.End, this._getReport());\n  }\n\n  /**\n   * Calculate bitrate by comparing bytes received between current time and the last time it was checked\n   */\n  private _checkBitrate(): void {\n    // No data yet\n    if (!this._lastCheckedTimestamp || !this._lastBytesChecked) {\n      this._lastCheckedTimestamp = Date.now();\n      this._lastBytesChecked = this._totalBytesReceived;\n      return;\n    }\n\n    // Calculate bitrate in kbps\n    const now = Date.now();\n    const bitrate = 8 * (this._totalBytesReceived - this._lastBytesChecked) / (now - this._lastCheckedTimestamp);\n\n    this._lastCheckedTimestamp = now;\n    this._lastBytesChecked = this._totalBytesReceived;\n    this._values.push(bitrate);\n    this.emit(BitrateTest.Events.Bitrate, bitrate);\n  }\n\n  /**\n   * Generate and returns the report for this test\n   */\n  private _getReport(): BitrateTest.Report {\n    let averageBitrate = this._values\n      .reduce((total: number, value: number) => total += value, 0) / this._values.length;\n    averageBitrate = isNaN(averageBitrate) ? 0 : averageBitrate;\n\n    return {\n      averageBitrate,\n      didPass: !this._errors.length && !!this._values.length && averageBitrate >= MIN_BITRATE_THRESHOLD,\n      errors: this._errors,\n      networkTiming: this._networkTiming,\n      testName: BitrateTest.testName,\n      testTiming: this._testTiming,\n      values: this._values,\n      warnings: this._warnings,\n    };\n  }\n\n  /**\n   * Emit a warning if currentStatValue exceeds threshold value\n   * @param name\n   * @param currentStatValue\n   */\n  private _maybeEmitWarning(name: BitrateTest.Warnings, currentStatValue: Number): void {\n    if (currentStatValue > BitrateTest.WarningThresholds[name]) {\n      this._warnings.push(name);\n      this.emit(BitrateTest.Events.Warning, name);\n    }\n  }\n\n  /**\n   * Called when an error is detected\n   * @param message - Message that describes the error\n   * @param error - The error object\n   * @param isFatal - Whether this is a fatal error\n   */\n  private _onError(message: string, error?: DOMError): void {\n    const diagnosticError = new DiagnosticError(error, message);\n    this._errors.push(diagnosticError);\n    this.emit(BitrateTest.Events.Error, diagnosticError);\n    this.stop();\n  }\n\n  /**\n   * Called when a local candidate is gathered\n   * @param remotePc - The remote RTCPeerConnection\n   */\n  private _onIceCandidate(remotePc: RTCPeerConnection, event: RTCPeerConnectionIceEvent): void {\n    if (event.candidate) {\n      const candidate = event.candidate.candidate;\n      if (candidate.indexOf('relay') !== -1) {\n        remotePc.addIceCandidate(event.candidate)\n          .catch((error: DOMError) => this._onError('Unable to add candidate', error));\n      }\n    }\n  }\n\n  /**\n   * Called when a message is received\n   * @param event\n   */\n  private _onMessageReceived(event: MessageEvent) {\n    this._totalBytesReceived += event.data.length;\n\n    if (!this._networkTiming.firstPacket) {\n      this._networkTiming.firstPacket = Date.now();\n      this._maybeEmitWarning(\n        BitrateTest.Warnings.HighFirstPacketDuration,\n        this._networkTiming.firstPacket - this._testTiming.start,\n      );\n    }\n  }\n\n  /**\n   * Called when an answer is created by the receiver\n   * @param answer - The answer session description created by the receiver RTCPeerConnection\n   */\n  private _onReceiverAnswerCreated(answer: RTCSessionDescriptionInit): Promise<void | [void, void]> {\n    return Promise.all([\n      this._pcReceiver.setLocalDescription(answer),\n      this._pcSender.setRemoteDescription(answer),\n    ]).catch((error: DOMError) =>\n      this._onError('Unable to set local or remote description from createAnswer', error));\n  }\n\n  /**\n   * Called when an offer has been created by the sender\n   * @param offer - The offer session description created by the sender RTCPeerConnection\n   */\n  private _onSenderOfferCreated(offer: RTCSessionDescriptionInit): Promise<void | [void, void]> {\n    return Promise.all([\n      this._pcSender.setLocalDescription(offer),\n      this._pcReceiver.setRemoteDescription(offer),\n    ]).catch((error: DOMError) =>\n      this._onError('Unable to set local or remote description from createOffer', error));\n  }\n\n  /**\n   * Send packets using data channel\n   */\n  private _sendData(): void {\n    if (!this._rtcDataChannel || this._rtcDataChannel.readyState !== 'open') {\n      return;\n    }\n    for (let i = 0; i < MAX_NUMBER_PACKETS; ++i) {\n      if (this._rtcDataChannel.bufferedAmount >= BYTES_KEEP_BUFFERED) {\n        break;\n      }\n      this._rtcDataChannel.send(TEST_PACKET);\n    }\n  }\n\n  /**\n   * Setup data channel for sending data\n   */\n  private _setupDataChannel(): void {\n    try {\n      this._rtcDataChannel = this._pcSender.createDataChannel('sender');\n    } catch (e) {\n      this._onError('Error creating data channel', e);\n      return;\n    }\n\n    this._rtcDataChannel.onopen = () => {\n      this._sendDataIntervalId = setInterval(() => this._sendData(), 1);\n      this._checkBitrateIntervalId = setInterval(() => this._checkBitrate(), 1000);\n    };\n\n    this._pcReceiver.ondatachannel = (dataChannelEvent: RTCDataChannelEvent) => {\n      dataChannelEvent.channel.onmessage = (event: MessageEvent) => this._onMessageReceived(event);\n    };\n  }\n\n  /**\n   * Setup network related event listeners on a PeerConnection\n   * @param pc\n   */\n  private _setupNetworkListeners(pc: RTCPeerConnection) {\n    // PeerConnection state\n    pc.onconnectionstatechange = () => {\n      this._networkTiming.peerConnection = this._networkTiming.peerConnection || { start: 0 };\n\n      if (pc.connectionState === 'connecting') {\n        this._networkTiming.peerConnection.start = Date.now();\n      } else if (pc.connectionState === 'connected') {\n        this._networkTiming.peerConnection.end = Date.now();\n\n        const { start, end } = this._networkTiming.peerConnection;\n        const duration = end - start;\n        this._networkTiming.peerConnection.duration = duration;\n        this._maybeEmitWarning(BitrateTest.Warnings.HighPcConnectDuration, duration);\n      }\n    };\n\n    // ICE Connection state\n    pc.oniceconnectionstatechange = () => {\n      this._networkTiming.ice = this._networkTiming.ice || { start: 0 };\n\n      if (pc.iceConnectionState === 'checking') {\n        this._networkTiming.ice.start = Date.now();\n      } else if (pc.iceConnectionState === 'connected') {\n        this._networkTiming.ice.end = Date.now();\n\n        const { start, end } = this._networkTiming.ice;\n        const duration = end - start;\n        this._networkTiming.ice.duration = duration;\n        this._maybeEmitWarning(BitrateTest.Warnings.HighIceConnectDuration, duration);\n      }\n    };\n  }\n\n  /**\n   * Starts the test.\n   */\n  private _startTest(): void {\n    this._testTiming.start = Date.now();\n\n    if (!this._rtcConfiguration.iceServers) {\n      return this._onError('No iceServers found', undefined);\n    }\n\n    this._pcSender.createOffer()\n      .then((offer: RTCSessionDescriptionInit) => this._onSenderOfferCreated(offer))\n      .then(() => {\n        return this._pcReceiver.createAnswer()\n          .then((answer: RTCSessionDescriptionInit) => this._onReceiverAnswerCreated(answer))\n          .catch((error: Error) => this._onError('Unable to create answer', error));\n      }).catch((error: Error) => this._onError('Unable to create offer', error));\n  }\n}\n\nexport namespace BitrateTest {\n  /**\n   * Possible events that a [[BitrateTest]] might emit. See [[BitrateTest.on]].\n   */\n  export enum Events {\n    Bitrate = 'bitrate',\n    End = 'end',\n    Error = 'error',\n    Warning = 'warning',\n  }\n\n  /**\n   * Possible warnings that a [[BitrateTest]] might emit. See [[BitrateTest.on]].\n   */\n  export enum Warnings {\n    /**\n     * Raised when [[NetworkTiming.firstPacket]] took more than 1400ms to arrive to the remote RTCPeerConnection.\n     * The duration is measured from the [[BitrateTest.Report]]'s testTiming.start up to [[NetworkTiming.firstPacket]]\n     */\n    HighFirstPacketDuration = 'high-first-packet-duration',\n\n    /**\n     * Raised when [[NetworkTiming.ice]] connection took more than 300ms to establish\n     */\n    HighIceConnectDuration = 'high-ice-connect-duration',\n\n    /**\n     * Raised when [[NetworkTiming.peerConnection]] took more than 1000ms to establish\n     */\n    HighPcConnectDuration = 'high-pc-connect-duration',\n  }\n\n  /**\n   * Thresholds used for determining when to raise a warning. See [[BitrateTest.Warnings]]\n   * @internalapi\n   */\n  export const WarningThresholds: Record<Warnings, Number> = {\n    [Warnings.HighFirstPacketDuration]: 1400,\n    [Warnings.HighIceConnectDuration]: 300,\n    [Warnings.HighPcConnectDuration]: 1000,\n  };\n\n  /**\n   * Options passed to [[BitrateTest]] constructor.\n   */\n  export interface Options {\n    /**\n     * The array of [RTCIceServer](https://developer.mozilla.org/en-US/docs/Web/API/RTCIceServer) configurations to use.\n     * You need to provide TURN server configurations to ensure that your network bitrate is tested.\n     * You you can use [Twilio's Network Traversal Service](https://www.twilio.com/stun-turn) to get TURN credentials.\n     *\n     * The following example demonstrates how to use the [twilio npm module](https://www.npmjs.com/package/twilio) to generate\n     * credentials with a ttl of 120 seconds, using UDP protocol, and specifying ashburn as the\n     * [edge location](https://www.twilio.com/docs/global-infrastructure/edge-locations).\n     *\n     * ```ts\n     * import Client from 'twilio';\n     * import { testBitrate } from '@twilio/rtc-diagnostics';\n     *\n     * // Generate the STUN and TURN server credentials with a ttl of 120 seconds\n     * const client = Client(twilioAccountSid, authToken);\n     * const token = await client.tokens.create({ ttl: 120 });\n     *\n     * // Filter for TURN servers.\n     * // Use the following filters if you want to use UDP, TCP, or TLS\n     * // UDP: turn:global.turn.twilio.com:3478?transport=udp\n     * // TCP: turn:global.turn.twilio.com:3478?transport=tcp\n     * // TLS: turn:global.turn.twilio.com:443?transport=tcp\n     * let { urls, username, credential } = token.iceServers\n     *   .find(item => item.url === 'turn:global.turn.twilio.com:3478?transport=udp');\n     *\n     * // By default, global will be used as the default edge location.\n     * // You can replace global with a specific edge name.\n     * urls = urls.replace('global', 'ashburn');\n     *\n     * // Use the TURN credentials using the iceServers parameter\n     * const bitrateTest = testBitrate({ iceServers: [{ urls, username, credential }] });\n     * ```\n     * Note, for production code, the above code should not be executed client side as it requires the authToken which must be treated like a private key.\n     */\n    iceServers: RTCIceServer[];\n  }\n\n  /**\n   * Represents the report generated from a [[BitrateTest]].\n   */\n  export interface Report {\n    /**\n     * Average bitrate calculated during the test.\n     */\n    averageBitrate: number;\n\n    /**\n     * Whether or not the test passed.\n     * The test is considered to be passing if there were no errors detected and average bitrate is greater than the minimum bitrate required to make a call.\n     * See [Network Bandwidth Requirements](https://www.twilio.com/docs/voice/client/javascript/voice-client-js-and-mobile-sdks-network-connectivity-requirements#network-bandwidth-requirements)\n     */\n    didPass: boolean;\n\n    /**\n     * Any errors that occurred during the test.\n     */\n    errors: DiagnosticError[];\n\n    /**\n     * Network related time measurements.\n     */\n    networkTiming: NetworkTiming;\n\n    /**\n     * The name of the test.\n     */\n    testName: string;\n\n    /**\n     * Time measurements of test run time.\n     */\n    testTiming: TimeMeasurement;\n\n    /**\n     * Bitrate values collected during the test.\n     */\n    values: number[];\n\n    /**\n     * Any warnings that occurred during the test.\n     */\n    warnings: Warnings[];\n  }\n}\n\n/**\n * The test uses two [RTCPeerConnections](https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection) connected via a Twilio TURN server.\n * Using [RTCDataChannel](https://developer.mozilla.org/en-US/docs/Web/API/RTCDataChannel), one RTCPeerConnection will saturate the data channel buffer and will\n * constantly send data packets to the other RTCPeerConnection. The receiving peer will measure the bitrate base on the amount of packets received every second.\n *\n * Example:\n * ```ts\n *   import { testBitrate } from '@twilio/rtc-diagnostics';\n *\n *   const bitrateTest = testBitrate({\n *     iceServers: [{\n *       credential: 'bar',\n *       username: 'foo',\n *       urls: 'turn:global.turn.twilio.com:3478?transport=udp',\n *     }],\n *   });\n *\n *   bitrateTest.on('bitrate', (bitrate) => {\n *     console.log(bitrate);\n *   });\n *\n *   bitrateTest.on('error', (error) => {\n *     console.log(error);\n *   });\n *\n *   bitrateTest.on('end', (report) => {\n *     console.log(report);\n *   });\n *\n *   // Run the test for 15 seconds\n *   setTimeout(() => {\n *     bitrateTest.stop();\n *   }, 15000);\n * ```\n * See [[BitrateTest.Options.iceServers]] for details on how to obtain TURN credentials.\n */\nexport function testBitrate(options: BitrateTest.Options): BitrateTest {\n  return new BitrateTest(options);\n}\n"]}